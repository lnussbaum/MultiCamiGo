<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MultiCamiGo üöÄ</title>
    
    <!-- PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f3e5f5">
    
    <!-- Inline SVG Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">

    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- Theming Variables --- */
        :root {
            --bg-color: #e3f2fd; 
            --container-bg: #ffffff;
            --text-main: #8e44ad;
            --text-sub: #6c757d;
            --primary-purple: #9b59b6;
            --soft-purple: #f5edfa;
            --border-color: #f5edfa;
            
            --choice-text: #9b59b6;
            --choice-border: #9b59b6;
            --choice-hover-bg: #9b59b6;
            --choice-hover-text: #fff;
            
            --error-red: #e74c3c;
            --success-green: #27ae60;
            --mistake-bg: #fff3cd;
            --mistake-text: #664d03;
            --mistake-border: #ffecb5;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-main: #bb86fc;
            --text-sub: #b0b3b8;
            --primary-purple: #bb86fc;
            --soft-purple: #333333;
            --border-color: #333333;
            --choice-text: #bb86fc;
            --choice-border: #bb86fc;
            --choice-hover-bg: #3700b3;
            --choice-hover-text: #fff;
            --mistake-bg: #3c3015;
            --mistake-text: #ffda6a;
            --mistake-border: #52421f;
        }

        /* --- Global Styles --- */
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            background: var(--container-bg);
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px;
            padding: 2rem;
            margin: 1rem;
            position: relative;
            border: 3px solid var(--border-color);
            overflow: hidden;
            transition: background 0.3s, border 0.3s;
        }

        h2, h1, h5 { color: var(--text-main); font-weight: 600; }
        .text-muted { color: var(--text-sub) !important; }

        /* Bootstrap Overrides */
        .form-check-input:checked { background-color: var(--primary-purple); border-color: var(--primary-purple); }
        .form-check-input:focus { border-color: var(--primary-purple); box-shadow: 0 0 0 0.25rem rgba(155, 89, 182, 0.25); }
        .form-range::-webkit-slider-thumb { background-color: var(--primary-purple); }
        .form-range:focus::-webkit-slider-thumb { box-shadow: 0 0 0 1px #fff, 0 0 0 0.25rem rgba(155, 89, 182, 0.25); }
        .form-control:focus, .form-select:focus { border-color: var(--primary-purple); box-shadow: 0 0 0 0.25rem rgba(155, 89, 182, 0.25); }
        
        .btn-outline-primary { color: var(--choice-text); border-color: var(--choice-border); }
        .btn-outline-primary:hover, .btn-outline-primary:active, .btn-check:checked + .btn-outline-primary {
            background-color: var(--choice-hover-bg) !important;
            border-color: var(--choice-border) !important;
            color: var(--choice-hover-text) !important;
            box-shadow: 0 0 0 0.25rem rgba(155, 89, 182, 0.25) !important;
        }

        .btn-primary {
            background-color: var(--primary-purple);
            border-color: var(--primary-purple);
            box-shadow: 0 4px 0px rgba(0,0,0,0.2);
            transition: all 0.1s;
        }
        .btn-primary:hover, .btn-primary:active {
            background-color: var(--text-main) !important;
            border-color: var(--text-main) !important;
            transform: translateY(2px);
            box-shadow: 0 2px 0px rgba(0,0,0,0.2), 0 0 0 0.25rem rgba(155, 89, 182, 0.25) !important;
        }

        .btn-outline-secondary { color: var(--text-sub); border-color: var(--text-sub); }
        .btn-outline-secondary:hover { background-color: var(--text-sub) !important; color: #fff !important; }
        
        /* Game Components */
        .question-display {
            font-size: 3.5rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 1rem 0;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.1);
            transition: color 0.2s;
        }

        .choice-btn {
            font-size: 1.6rem;
            border-radius: 15px;
            border-width: 2px;
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 5px !important;
            touch-action: manipulation;
        }
        
        .progress-badge { background-color: var(--container-bg) !important; color: var(--text-main) !important; border: 2px solid var(--soft-purple) !important; }
        .mode-badge { background-color: var(--primary-purple) !important; color: white !important; }
        
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .feedback { height: 100px; display: flex; align-items: center; justify-content: center; flex-direction: column; margin-bottom: 0.5rem; }
        .feedback-text { font-size: 2.5rem; font-weight: 600; }
        .feedback-emoji { font-size: 3.5rem; line-height: 1; }

        #interactionZone { position: relative; margin-bottom: 1.5rem; }
        #buttonsArea { display: grid; gap: 10px; width: 100%; transition: opacity 0.2s; }
        #nextButtonArea {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; z-index: 10; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        #nextButtonArea.active { pointer-events: auto; opacity: 1; }
        .invisible-layout { opacity: 0; pointer-events: none; }

        .mistake-item {
            background-color: var(--mistake-bg); border: 1px solid var(--mistake-border); color: var(--mistake-text);
            border-radius: 10px; padding: 8px 15px; margin-bottom: 8px; font-weight: 600; display: inline-block; margin-right: 5px;
        }
        
        .top-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 100; }
        .control-icon { cursor: pointer; font-size: 1.5rem; color: var(--text-sub); transition: transform 0.2s; }
        .control-icon:hover { transform: scale(1.1); }
        
        .bg-light { background-color: var(--soft-purple) !important; }
        .record-display { font-size: 0.9rem; color: var(--primary-purple); font-weight: 600; background: var(--soft-purple); padding: 5px 15px; border-radius: 20px; display: inline-block; margin-top: 15px; }
    </style>
</head>
<body>

<div class="app-container text-center">
    <div class="top-controls">
        <div class="control-icon" onclick="App.toggleLang()" id="langIcon">üá¨üáß</div>
        <div class="control-icon" onclick="App.toggleTheme()">
            <i class="bi bi-moon-stars-fill" id="themeIcon"></i>
        </div>
    </div>

    <!-- CONFIGURATION SCREEN -->
    <div id="configScreen" class="screen active">
        <h1 class="mb-1"><i class="bi bi-stars text-warning"></i> MultiCamiGo</h1>
        <p class="text-muted mb-3 small" data-i18n="subtitle">Apprends en t'amusant !</p>
        
        <div class="mb-3">
            <label class="form-label fw-bold"><i class="bi bi-grid-3x3-gap-fill text-primary"></i> <span data-i18n="pickTables">Choisis les tables :</span></label>
            <div class="d-flex flex-wrap justify-content-center" id="tablesContainer"></div>
            <div class="mt-1">
                <button class="btn btn-sm btn-link text-decoration-none text-purple" style="color:var(--primary-purple)" onclick="UI.toggleAllTables(true)">
                    <i class="bi bi-check-all"></i> <span data-i18n="all">Toutes</span>
                </button>
                <button class="btn btn-sm btn-link text-decoration-none text-muted" onclick="UI.toggleAllTables(false)">
                    <i class="bi bi-x-circle"></i> <span data-i18n="none">Aucune</span>
                </button>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold"><i class="bi bi-controller text-success"></i> <span data-i18n="howToAnswer">Comment r√©pondre ?</span></label>
            <div class="d-flex gap-3 justify-content-center mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="inputMode" id="inputButtons" value="buttons" checked onchange="UI.updateConfigDisplay()">
                    <label class="form-check-label" for="inputButtons">
                        <i class="bi bi-ui-checks-grid"></i> <span data-i18n="buttons">Boutons</span>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="inputMode" id="inputKeyboard" value="keyboard" onchange="UI.updateConfigDisplay()">
                    <label class="form-check-label" for="inputKeyboard">
                        <i class="bi bi-keyboard"></i> <span data-i18n="keyboard">Clavier</span>
                    </label>
                </div>
            </div>
            <div id="buttonsCountConfig" class="bg-light p-2 rounded mb-2">
                <label class="form-label small"><span data-i18n="btnCount">Nombre de boutons :</span> <span id="choiceCountVal" class="fw-bold">4</span></label>
                <input type="range" class="form-range" min="3" max="8" value="4" id="choiceCountRange" oninput="UI.updateConfigDisplay()">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold small"><i class="bi bi-puzzle-fill text-danger"></i> <span data-i18n="formats">Formats :</span></label>
            <div class="d-flex flex-wrap justify-content-center gap-3 small">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="fmtStandard" checked onchange="UI.updateConfigDisplay()">
                    <label class="form-check-label" for="fmtStandard">2 x 3 = ?</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="fmtStandardReverse" checked onchange="UI.updateConfigDisplay()">
                    <label class="form-check-label" for="fmtStandardReverse">3 x 2 = ?</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="fmtMissingRight" onchange="UI.updateConfigDisplay()">
                    <label class="form-check-label" for="fmtMissingRight">2 x ? = 6</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="fmtMissingLeft" onchange="UI.updateConfigDisplay()">
                    <label class="form-check-label" for="fmtMissingLeft">? x 3 = 6</label>
                </div>
            </div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-6 text-start">
                <label class="form-label fw-bold small"><i class="bi bi-trophy-fill text-warning"></i> <span data-i18n="mode">Mode :</span></label>
                <select class="form-select" id="modeSelect" onchange="UI.updateConfigDisplay()">
                    <option value="fixed" data-i18n="modeFixed">S√©rie de questions</option>
                    <option value="streak" data-i18n="modeStreak">Suite gagnante</option>
                    <option value="sprint" data-i18n="modeSprint">Sprint</option>
                </select>
            </div>
            <div class="col-6 text-start">
                <div id="targetConfigDiv">
                    <label class="form-label fw-bold small" id="targetLabel" data-i18n="count">Nombre :</label>
                    <input type="number" class="form-control" id="targetValue" value="20" onchange="UI.updateConfigDisplay()">
                </div>
                <div id="sprintConfigDiv" class="d-none">
                    <label class="form-label fw-bold small" data-i18n="duration">Dur√©e :</label>
                    <select class="form-select" id="sprintDuration" onchange="UI.updateConfigDisplay()">
                        <option value="60" selected data-i18n="min1">1 minute</option>
                        <option value="120" data-i18n="min2">2 minutes</option>
                        <option value="180" data-i18n="min3">3 minutes</option>
                        <option value="300" data-i18n="min5">5 minutes</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="mb-4" id="timeConfigDiv">
            <label class="form-label fw-bold small"><i class="bi bi-stopwatch-fill text-info"></i> <span data-i18n="timer">Chrono (par question) :</span></label>
            <select class="form-select" id="timeLimit" onchange="UI.updateConfigDisplay()">
                <option value="0" data-i18n="unlimited">Illimit√©</option>
                <option value="5" data-i18n="expert">5s (Expert ‚ö°)</option>
                <option value="10" selected data-i18n="normal">10s (Normal)</option>
                <option value="20" data-i18n="chill">20s (Tranquille üê¢)</option>
            </select>
        </div>

        <div class="form-check form-switch d-flex justify-content-center mb-3">
            <input class="form-check-input me-2" type="checkbox" id="soundToggle" checked onchange="UI.updateConfigDisplay()">
            <label class="form-check-label" for="soundToggle"><span data-i18n="sound">Sons activ√©s</span> üîä</label>
        </div>

        <div id="bestScoreDisplay" class="record-display d-none">
            <i class="bi bi-award-fill"></i> <span data-i18n="record">Record :</span> <span id="recordValue">-</span>
        </div>

        <div class="mt-4">
            <button class="btn btn-primary w-100 py-3 fw-bold text-white shadow-sm" onclick="App.startGame()">
                <i class="bi bi-play-circle-fill"></i> <span data-i18n="start">COMMENCER</span>
            </button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen" class="screen">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-outline-secondary btn-sm rounded-pill px-3" onclick="App.stopGame()">
                <i class="bi bi-x-lg"></i> <span data-i18n="menu">Menu</span>
            </button>
            <span class="badge rounded-pill mode-badge" id="modeBadge">S√©rie</span>
        </div>

        <div class="text-center mb-2">
            <span class="badge rounded-pill progress-badge" id="progressBadge">1 / 20</span>
        </div>
        
        <div class="progress mb-4" style="height: 12px; background-color: var(--soft-purple); border-radius: 10px;">
            <div id="timerFill" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%;"></div>
        </div>

        <div id="gameFeedback" class="feedback"></div>

        <div class="question-display" id="questionText">2 x 2 = ?</div>

        <div id="interactionZone">
            <div id="keyboardArea" class="row g-2 justify-content-center d-none">
                <div class="col-6">
                    <input type="number" id="answerInput" class="form-control form-control-lg text-center" placeholder="?" inputmode="numeric" style="font-size: 2rem;">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary btn-lg" onclick="App.submitAnswer()">
                        <i class="bi bi-arrow-return-left"></i>
                    </button>
                </div>
            </div>

            <div id="buttonsArea" class=""></div>

            <div id="nextButtonArea">
                <button id="btnNext" class="btn btn-primary btn-lg px-5 py-3 shadow-sm fw-bold" style="font-size: 1.4rem;" onclick="App.nextQuestion()">
                    <span data-i18n="next">Suivant</span> <i class="bi bi-arrow-right-circle-fill"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="resultScreen" class="screen">
        <h2 class="mb-4" id="resultTitle" style="font-size: 2.5rem;">Fini ! üéä</h2>
        
        <div id="newRecordMsg" class="alert alert-success d-none fw-bold mb-4">
            <i class="bi bi-trophy-fill"></i> <span data-i18n="newRecord">NOUVEAU RECORD !</span>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-6">
                <div class="p-3 bg-light rounded-4">
                    <small class="text-muted"><i class="bi bi-bullseye"></i> <span data-i18n="score">Score</span></small>
                    <div class="h3 mb-0 stat-value" id="scoreValue">18/20</div>
                </div>
            </div>
            <div class="col-6">
                <div class="p-3 bg-light rounded-4">
                    <small class="text-muted"><i class="bi bi-lightning-charge"></i> <span data-i18n="speed">Vitesse</span></small>
                    <div class="h3 mb-0 stat-value" id="timeValue">3.5s</div>
                </div>
            </div>
        </div>

        <div id="mistakesArea" class="mb-4 d-none">
            <h5 class="text-danger mb-2"><i class="bi bi-exclamation-triangle"></i> <span data-i18n="mistakes">√Ä revoir :</span></h5>
            <div id="mistakesList"></div>
        </div>

        <button class="btn btn-primary w-100 py-3 fw-bold text-white mb-2" onclick="App.showConfig()">
            <i class="bi bi-arrow-repeat"></i> <span data-i18n="replay">REJOUER</span>
        </button>
    </div>

</div>

<script>
/**
 * MultiCamiGo - Architecture Clean Refactor
 * Namespace Structure:
 * - Storage: Config & Records persistence
 * - Sound: Audio system (Synth + Ext + Speech)
 * - GameLogic: Pure math & state logic
 * - UI: DOM manipulation & display
 * - App: Main controller
 */

/* --- 1. Storage (Persistence) --- */
const Storage = {
    KEYS: { CONFIG: 'mm_config_v1', RECORDS: 'mm_records_v1' },
    
    // Default Configuration
    defaults: {
        tables: [2, 3, 4, 5],
        formats: ['standard'],
        mode: 'fixed',
        inputType: 'buttons',
        choiceCount: 4,
        target: 20, // or streak count
        timeLimit: 10,
        sprintDuration: 60,
        sound: true,
        lang: 'fr'
    },

    loadConfig() {
        const saved = localStorage.getItem(this.KEYS.CONFIG);
        return saved ? { ...this.defaults, ...JSON.parse(saved) } : this.defaults;
    },

    saveConfig(config) {
        localStorage.setItem(this.KEYS.CONFIG, JSON.stringify(config));
    },

    getRecords() {
        return JSON.parse(localStorage.getItem(this.KEYS.RECORDS) || '{}');
    },

    saveRecord(hash, data) {
        const records = this.getRecords();
        records[hash] = data;
        localStorage.setItem(this.KEYS.RECORDS, JSON.stringify(records));
    },

    generateHash(c) {
        return JSON.stringify({
            t: c.tables.slice().sort(),
            m: c.mode,
            v: c.mode === 'sprint' ? c.sprintDuration : c.target,
            i: c.inputType,
            tl: c.timeLimit,
            fmt: c.formats.slice().sort()
        });
    }
};

/* --- 2. Sound (Audio System) --- */
const Sound = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    notes: {
        C4: 261.63, D4: 293.66, E4: 329.63, F4: 349.23, G4: 392.00, A4: 440.00, B4: 493.88,
        C5: 523.25, D5: 587.33, E5: 659.25, F5: 698.46, G5: 783.99, A5: 880.00, B5: 987.77,
        C6: 1046.50, D6: 1174.66
    },
    cache: {},
    clips: {
        fanfare: 'https://actions.google.com/sounds/v1/cartoon/trumpet_fanfare.ogg',
        boing: 'https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg',
        cheer: 'https://actions.google.com/sounds/v1/crowds/battle_crowd_celebrate_stutter.ogg'
    },

    init() {
        Object.keys(this.clips).forEach(key => {
            const a = new Audio(this.clips[key]);
            a.preload = 'auto';
            this.cache[key] = a;
        });
    },

    enabled() { return document.getElementById('soundToggle').checked; },

    playTone(freq, type, duration, startTime = 0, vol = 0.1) {
        if (!this.enabled()) return;
        if (this.ctx.state === 'suspended') this.ctx.resume();
        
        const t = startTime || this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.type = type;
        osc.frequency.setValueAtTime(freq, t);
        
        gain.gain.setValueAtTime(0, t);
        gain.gain.linearRampToValueAtTime(vol, t + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, t + duration);

        osc.connect(gain);
        gain.connect(this.ctx.destination);
        
        osc.start(t);
        osc.stop(t + duration);
    },

    playMelody(notes, tempo = 150) {
        if (!this.enabled()) return;
        const beat = 60 / tempo;
        let t = this.ctx.currentTime;
        notes.forEach(n => {
            if (n.freq) this.playTone(n.freq, n.type || 'triangle', n.dur * beat, t);
            t += n.dur * beat;
        });
    },

    playClip(name) {
        if (!this.enabled() || !this.cache[name]) return null;
        const clone = this.cache[name].cloneNode();
        clone.volume = 0.5;
        clone.play().catch(() => {});
        return clone;
    },

    speak(text, lang = 'fr') {
        if (!this.enabled() || !window.speechSynthesis) return;
        window.speechSynthesis.cancel(); // Interrupt
        const u = new SpeechSynthesisUtterance(text);
        u.lang = (lang === 'fr' ? 'fr-FR' : 'en-US');
        u.rate = 1.0;
        u.pitch = 1.1;
        window.speechSynthesis.speak(u);
    },

    // Events
    correct() {
        this.playTone(this.notes.C5, 'sine', 0.1, 0, 0.1);
        this.playTone(this.notes.E5, 'sine', 0.2, this.ctx.currentTime + 0.08, 0.1);
    },
    
    wrong() {
        if (!this.playClip('boing')) {
            this.playTone(150, 'sawtooth', 0.3, 0, 0.15);
            this.playTone(100, 'sawtooth', 0.3, this.ctx.currentTime + 0.15, 0.15);
        }
    },
    
    streak(count, lang) {
        if (count === 5) {
            this.speak(lang === 'fr' ? "Super !" : "Super!", lang);
            this.playMelody([{ freq: this.notes.C5, dur: 0.25 }, { freq: this.notes.E5, dur: 0.25 }, { freq: this.notes.G5, dur: 0.5 }], 200);
        } else if (count === 10) {
            this.speak(lang === 'fr' ? "Incroyable !" : "Amazing!", lang);
            this.playMelody([{ freq: this.notes.G4, dur: 0.2 }, { freq: this.notes.C5, dur: 0.2 }, { freq: this.notes.E5, dur: 0.2 }, { freq: this.notes.G5, dur: 0.6 }], 200);
        } else if (count === 20) {
            this.speak(lang === 'fr' ? "L√©gendaire !" : "Legendary!", lang);
            if (!this.playClip('fanfare')) {
                this.playMelody([{ freq: this.notes.C5, dur: 0.2, type: 'square' }, { freq: this.notes.G5, dur: 0.2, type: 'square' }, { freq: this.notes.C6, dur: 0.8, type: 'square' }], 200);
            }
        }
    },

    win(lang) {
        this.speak(lang === 'fr' ? "Victoire !" : "Victory!", lang);
        const cheer = this.playClip('cheer');
        if (cheer) {
            setTimeout(() => {
                const fade = setInterval(() => {
                    if (cheer.volume > 0.05) cheer.volume -= 0.05;
                    else { cheer.pause(); clearInterval(fade); }
                }, 100);
            }, 4000);
        }
        this.playMelody([{ freq: this.notes.C4, dur: 0.2 }, { freq: this.notes.E4, dur: 0.2 }, { freq: this.notes.G4, dur: 0.2 }, { freq: this.notes.C5, dur: 0.4 }, { freq: this.notes.G4, dur: 0.2 }, { freq: this.notes.C5, dur: 0.8 }], 180);
    }
};

/* --- 3. GameLogic (Pure State) --- */
const GameLogic = {
    state: {}, // score, count, totalT, correctC, retryQueue, mistakes
    
    init(config) {
        this.state = {
            score: 0,
            count: 0, // streak
            totalT: 0,
            correctC: 0,
            retryQueue: [],
            mistakes: [],
            startTime: 0,
            cur: null
        };
    },

    generateQuestion(config) {
        if (this.state.retryQueue.length > 0) {
            const idx = Math.floor(Math.random() * this.state.retryQueue.length);
            return this.state.retryQueue.splice(idx, 1)[0];
        }

        const table = config.tables[Math.floor(Math.random() * config.tables.length)];
        const mult = Math.floor(Math.random() * 10) + 1;
        const res = table * mult;
        const fmt = config.formats[Math.floor(Math.random() * config.formats.length)];

        let qText = "", ans = 0;
        const full = `${table} x ${mult} = ${res}`;

        if (fmt === 'standard') { qText = `${table} x ${mult} = ?`; ans = res; }
        else if (fmt === 'standardreverse') { qText = `${mult} x ${table} = ?`; ans = res; }
        else if (fmt === 'missingright') {
            if (Math.random() < 0.5) { qText = `${table} x ? = ${res}`; ans = mult; }
            else { qText = `${mult} x ? = ${res}`; ans = table; }
        } else if (fmt === 'missingleft') {
            if (Math.random() < 0.5) { qText = `? x ${mult} = ${res}`; ans = table; }
            else { qText = `? x ${table} = ${res}`; ans = mult; }
        }

        return { q: qText, ans: ans, full: full };
    },

    checkAnswer(val, elapsedSec, configMode) {
        const isCorrect = (val === this.state.cur.ans);
        
        if (isCorrect) {
            this.state.score++;
            this.state.count++; // Streak
            this.state.totalT += elapsedSec;
            this.state.correctC++;
        } else {
            this.state.count = 0; // Reset streak
            if (!this.state.mistakes.includes(this.state.cur.full)) {
                this.state.mistakes.push(this.state.cur.full);
            }
            if (configMode === 'fixed') {
                this.state.retryQueue.push(this.state.cur);
            }
        }
        return { isCorrect, streak: this.state.count };
    },

    isFinished(config) {
        if (config.mode === 'fixed' && this.state.score >= config.target) return true;
        if (config.mode === 'streak' && this.state.count >= config.target) return true;
        return false;
    }
};

/* --- 4. UI (Display) --- */
const UI = {
    // Languages
    lang: 'fr',
    translations: {
        fr: {
            subtitle: "Apprends en t'amusant !", pickTables: "Choisis les tables :", all: "Toutes", none: "Aucune",
            howToAnswer: "Comment r√©pondre ?", buttons: "Boutons", keyboard: "Clavier", btnCount: "Nombre de boutons :",
            formats: "Formats :", mode: "Mode :", modeFixed: "Nombre de questions", modeStreak: "S√©rie gagnante", modeSprint: "Sprint",
            count: "Quantit√© :", duration: "Dur√©e :", timer: "Chrono (par question) :", sound: "Sons activ√©s",
            record: "Record :", start: "COMMENCER", menu: "Menu", next: "Suivant", newRecord: "NOUVEAU RECORD !",
            score: "Score", speed: "Vitesse", mistakes: "√Ä revoir :", replay: "REJOUER", min1: "1 minute",
            min2: "2 minutes", min3: "3 minutes", min5: "5 minutes", unlimited: "Illimit√©", expert: "5s (Expert ‚ö°)",
            normal: "10s (Normal)", chill: "20s (Tranquille üê¢)", bravo: "Bravo !", oops: "Oups !", timesUp: "Temps √©coul√© !",
            finished: "Fini ! üéä", champion: "Champion ! üèÜü•á", wellDone: "Bien jou√© ! üéâ", timeAttackEnd: "Temps √©coul√© ! ‚ö°",
            pts: "pts", streak: "√† la suite", targetStreak: "Objectif :", alertNoTable: "Choisis au moins une table !",
            alertNoFormat: "Choisis au moins un format !"
        },
        en: {
            subtitle: "Learn while having fun!", pickTables: "Pick tables:", all: "All", none: "None",
            howToAnswer: "Input method?", buttons: "Buttons", keyboard: "Keyboard", btnCount: "Button count:",
            formats: "Formats:", mode: "Mode:", modeFixed: "Series", modeStreak: "Streak", modeSprint: "Sprint",
            count: "Count:", duration: "Duration:", timer: "Timer (per question):", sound: "Sound On",
            record: "Record:", start: "START", menu: "Menu", next: "Next", newRecord: "NEW RECORD!",
            score: "Score", speed: "Speed", mistakes: "Review:", replay: "PLAY AGAIN", min1: "1 minute",
            min2: "2 minutes", min3: "3 minutes", min5: "5 minutes", unlimited: "Unlimited", expert: "5s (Expert ‚ö°)",
            normal: "10s (Normal)", chill: "20s (Chill üê¢)", bravo: "Great!", oops: "Oops!", timesUp: "Time's up!",
            finished: "Finished! üéä", champion: "Champion! üèÜü•á", wellDone: "Well done! üéâ", timeAttackEnd: "Time's up! ‚ö°",
            pts: "pts", streak: "streak", targetStreak: "Target:", alertNoTable: "Pick at least one table!",
            alertNoFormat: "Pick at least one format!"
        }
    },

    init() {
        this.renderTableSelectors();
        this.bindEvents();
    },

    bindEvents() {
        document.getElementById('answerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') App.submitAnswer();
        });
    },

    renderTableSelectors() {
        const container = document.getElementById('tablesContainer');
        container.innerHTML = '';
        for (let i = 1; i <= 13; i++) {
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.className = 'btn-check';
            input.id = `tbl${i}`;
            input.value = i;
            input.onclick = () => this.updateConfigDisplay();
            
            const label = document.createElement('label');
            label.className = 'btn btn-outline-primary m-1 rounded-circle';
            label.style.cssText = 'width:45px;height:45px;display:inline-flex;align-items:center;justify-content:center;font-weight:bold';
            label.htmlFor = `tbl${i}`;
            label.innerText = i;
            
            container.appendChild(input);
            container.appendChild(label);
        }
    },

    toggleAllTables(state) {
        for (let i = 1; i <= 13; i++) document.getElementById(`tbl${i}`).checked = state;
        this.updateConfigDisplay();
    },

    setLang(lang) {
        this.lang = lang;
        document.documentElement.lang = lang;
        document.getElementById('langIcon').innerText = (lang === 'fr' ? 'üá¨üáß' : 'üá´üá∑');
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (this.translations[lang][key]) el.innerText = this.translations[lang][key];
        });
        this.updateConfigDisplay();
    },

    setTheme(isDark) {
        const body = document.body;
        const icon = document.getElementById('themeIcon');
        body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        icon.className = isDark ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
        document.querySelector('meta[name="theme-color"]').setAttribute('content', isDark ? '#1a1a2e' : '#e3f2fd');
    },

    showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    },

    getConfigFromUI() {
        const tables = Array.from({ length: 13 }, (_, i) => i + 1).filter(i => document.getElementById(`tbl${i}`).checked);
        const formats = ['fmtStandard', 'fmtStandardReverse', 'fmtMissingRight', 'fmtMissingLeft']
            .filter(id => document.getElementById(id).checked)
            .map(id => id.replace('fmt', '').toLowerCase());
        
        return {
            tables, formats,
            mode: document.getElementById('modeSelect').value,
            inputType: document.getElementById('inputButtons').checked ? 'buttons' : 'keyboard',
            choiceCount: parseInt(document.getElementById('choiceCountRange').value),
            target: parseInt(document.getElementById('targetValue').value),
            timeLimit: parseInt(document.getElementById('timeLimit').value),
            sprintDuration: parseInt(document.getElementById('sprintDuration').value),
            sound: document.getElementById('soundToggle').checked,
            lang: this.lang
        };
    },

    loadConfigToUI(c) {
        // Tables
        for (let i = 1; i <= 13; i++) document.getElementById(`tbl${i}`).checked = c.tables.includes(i);
        // Formats
        ['fmtStandard', 'fmtStandardReverse', 'fmtMissingRight', 'fmtMissingLeft'].forEach(id => {
            const key = id.replace('fmt', '').toLowerCase();
            document.getElementById(id).checked = c.formats.includes(key);
        });
        document.getElementById('modeSelect').value = c.mode;
        document.getElementById(c.inputType === 'buttons' ? 'inputButtons' : 'inputKeyboard').checked = true;
        document.getElementById('choiceCountRange').value = c.choiceCount;
        document.getElementById('targetValue').value = c.target;
        document.getElementById('timeLimit').value = c.timeLimit;
        document.getElementById('sprintDuration').value = c.sprintDuration;
        document.getElementById('soundToggle').checked = c.sound;
        this.setLang(c.lang || 'fr');
    },

    updateConfigDisplay() {
        const c = this.getConfigFromUI();
        const t = this.translations[this.lang];
        
        // Visibility toggles
        document.getElementById('sprintConfigDiv').classList.toggle('d-none', c.mode !== 'sprint');
        document.getElementById('targetConfigDiv').classList.toggle('d-none', c.mode === 'sprint');
        document.getElementById('timeConfigDiv').style.display = (c.mode === 'sprint' ? 'none' : 'block');
        document.getElementById('buttonsCountConfig').classList.toggle('d-none', c.inputType !== 'buttons');
        
        // Labels
        document.getElementById('targetLabel').innerText = (c.mode === 'fixed' ? t.count : t.targetStreak);
        document.getElementById('choiceCountVal').innerText = c.choiceCount;

        // Record
        const hash = Storage.generateHash(c);
        const records = Storage.getRecords();
        const rec = records[hash];
        const recDisplay = document.getElementById('bestScoreDisplay');
        
        if (rec) {
            recDisplay.classList.remove('d-none');
            const val = document.getElementById('recordValue');
            if (c.mode === 'sprint') val.innerText = `${rec.score} ${t.pts}`;
            else if (c.mode === 'fixed') val.innerText = `${rec.time}s`;
            else val.innerText = `${rec.score} ${t.streak}`;
        } else {
            recDisplay.classList.add('d-none');
        }
        
        Storage.saveConfig(c); // Auto-save
    },

    // Game UI
    setupGameUI(config) {
        const t = this.translations[this.lang];
        const badge = document.getElementById('modeBadge');
        if (config.mode === 'fixed') badge.innerText = t.modeFixed;
        else if (config.mode === 'streak') badge.innerText = t.modeStreak;
        else badge.innerText = '‚ö° ' + t.modeSprint;
        
        this.showScreen('gameScreen');
        document.getElementById('keyboardArea').classList.add('d-none');
        document.getElementById('buttonsArea').classList.add('d-none');
    },

    showQuestion(qData, config, state) {
        // Reset Views
        document.getElementById('nextButtonArea').classList.remove('active');
        document.getElementById('gameFeedback').innerHTML = '';
        
        const keyArea = document.getElementById('keyboardArea');
        const btnArea = document.getElementById('buttonsArea');
        
        keyArea.classList.toggle('d-none', config.inputType === 'buttons');
        keyArea.classList.remove('invisible-layout');
        btnArea.classList.toggle('d-none', config.inputType === 'keyboard');
        btnArea.classList.remove('invisible-layout');

        // Update Badge
        const t = this.translations[this.lang];
        const badge = document.getElementById('progressBadge');
        if (config.mode === 'fixed') badge.innerText = `${state.score + 1} / ${config.target}`;
        else if (config.mode === 'streak') badge.innerText = `${t.streak} : ${state.count} / ${config.target}`;
        else if (config.mode === 'sprint') badge.innerText = `${t.score} : ${state.score}`;

        // Text
        const qEl = document.getElementById('questionText');
        qEl.innerText = qData.q;
        qEl.style.color = 'var(--text-main)';

        // Inputs
        if (config.inputType === 'keyboard') {
            const inp = document.getElementById('answerInput');
            inp.value = '';
            setTimeout(() => inp.focus(), 50);
        } else {
            this.generateButtons(qData.ans, config.choiceCount);
        }
    },

    generateButtons(correct, count) {
        const area = document.getElementById('buttonsArea');
        let cols = count > 5 ? Math.ceil(count / 2) : count;
        area.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        area.innerHTML = '';
        
        const offset = Math.floor(Math.random() * count);
        const start = Math.max(0, correct - offset);
        
        for (let i = 0; i < count; i++) {
            const val = start + i;
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-primary choice-btn';
            btn.innerText = val;
            btn.onclick = () => App.submitAnswer(val);
            area.appendChild(btn);
        }
    },

    showFeedback(isCorrect, isTimeout, qData) {
        const t = this.translations[this.lang];
        const fbEl = document.getElementById('gameFeedback');
        const qEl = document.getElementById('questionText');
        
        // Emojis
        const emojis = ['ü¶Ñ','ü¶ñ','üç¶','üåà','üê±','üöÄ','üåü','üç≠','ü¶Å','üê∂','üçï','üé®','üõ∏','üê≥','üçÄ'];
        
        if (isCorrect) {
            const em = emojis[Math.floor(Math.random() * emojis.length)];
            fbEl.innerHTML = `<div class="feedback-text text-success">${t.bravo}</div><div class="feedback-emoji">${em}</div>`;
            qEl.innerText = qData.full;
            qEl.style.color = "var(--success-green)";
        } else {
            const msg = isTimeout ? t.timesUp : t.oops;
            const icon = isTimeout ? '<i class="bi bi-alarm"></i>' : '<i class="bi bi-lightbulb"></i>';
            fbEl.innerHTML = `<div class="feedback-text text-danger">${msg}</div><div class="feedback-emoji text-danger">${icon}</div>`;
            qEl.innerText = qData.full;
            qEl.style.color = "var(--error-red)";
            
            // Hide inputs
            document.getElementById('keyboardArea').classList.add('invisible-layout');
            document.getElementById('buttonsArea').classList.add('invisible-layout');
            document.getElementById('nextButtonArea').classList.add('active');
            document.getElementById('btnNext').focus();
        }
    },

    updateTimerBar(percent, isWarning) {
        const bar = document.getElementById('timerFill');
        bar.style.width = `${percent}%`;
        bar.style.backgroundColor = isWarning ? 'var(--error-red)' : 'var(--primary-purple)';
    },

    showResults(state, config, isNewRecord) {
        this.showScreen('resultScreen');
        const t = this.translations[this.lang];
        const avgTime = (state.correctC ? (state.totalT / state.correctC).toFixed(1) : "0");

        // Title & Score
        let title = "", scoreTxt = "";
        if (config.mode === 'sprint') {
            title = t.timeAttackEnd;
            scoreTxt = `${state.score} ${t.pts}`;
        } else {
            scoreTxt = (config.mode === 'fixed' ? `${state.score} / ${state.score}` : `${state.count} ${t.streak}`);
            title = (config.mode === 'streak' || state.mistakes.length === 0) ? t.champion : t.wellDone;
        }

        document.getElementById('resultTitle').innerText = title;
        document.getElementById('scoreValue').innerText = scoreTxt;
        document.getElementById('timeValue').innerText = avgTime + 's';
        document.getElementById('newRecordMsg').classList.toggle('d-none', !isNewRecord);

        // Mistakes
        const mArea = document.getElementById('mistakesArea');
        if (state.mistakes.length > 0) {
            mArea.classList.remove('d-none');
            document.getElementById('mistakesList').innerHTML = state.mistakes.map(m => `<span class="mistake-item">${m}</span>`).join('');
        } else {
            mArea.classList.add('d-none');
        }
    }
};

/* --- 5. App (Main Controller) --- */
const App = {
    config: {},
    timer: null,
    sprintTimer: null,

    init() {
        Sound.init();
        UI.init();
        const saved = Storage.loadConfig();
        UI.loadConfigToUI(saved);
        UI.updateConfigDisplay(); // Trigger initial view update
    },

    toggleLang() {
        const next = UI.lang === 'fr' ? 'en' : 'fr';
        UI.setLang(next);
    },

    toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        UI.setTheme(!isDark);
    },

    showConfig() {
        UI.showScreen('configScreen');
        UI.updateConfigDisplay();
    },

    startGame() {
        this.config = UI.getConfigFromUI();
        const t = UI.translations[this.config.lang];

        if (this.config.tables.length === 0) return alert(t.alertNoTable);
        if (this.config.formats.length === 0) return alert(t.alertNoFormat);

        Sound.ctx.resume();
        GameLogic.init(this.config);
        UI.setupGameUI(this.config);

        if (this.config.mode === 'sprint') this.startSprintTimer();
        this.nextQuestion();
    },

    stopGame() {
        this.clearTimers();
        this.showConfig();
    },

    clearTimers() {
        if (this.timer) clearInterval(this.timer);
        if (this.sprintTimer) clearInterval(this.sprintTimer);
    },

    startSprintTimer() {
        let timeLeft = this.config.sprintDuration;
        UI.updateTimerBar(100, false);
        
        this.sprintTimer = setInterval(() => {
            timeLeft--;
            const pct = (timeLeft / this.config.sprintDuration) * 100;
            UI.updateTimerBar(pct, timeLeft <= 10);
            
            if (timeLeft <= 0) {
                this.clearTimers();
                this.finishGame();
            }
        }, 1000);
    },

    nextQuestion() {
        // Check win condition
        if (GameLogic.isFinished(this.config)) {
            return this.finishGame();
        }

        // Logic
        GameLogic.state.cur = GameLogic.generateQuestion(this.config);
        GameLogic.state.startTime = Date.now();
        
        // UI
        UI.showQuestion(GameLogic.state.cur, this.config, GameLogic.state);
        
        // Timer
        if (this.config.mode !== 'sprint') this.startQuestionTimer();
    },

    startQuestionTimer() {
        if (this.timer) clearInterval(this.timer);
        if (!this.config.timeLimit) {
            UI.updateTimerBar(100, false);
            return;
        }

        const limitMs = this.config.timeLimit * 1000;
        const start = Date.now();
        
        this.timer = setInterval(() => {
            const elapsed = Date.now() - start;
            const remaining = limitMs - elapsed;
            
            if (remaining <= 0) {
                clearInterval(this.timer);
                this.submitAnswer(-1); // Timeout
                return;
            }
            UI.updateTimerBar((remaining / limitMs) * 100, remaining <= 5000);
        }, 50);
    },

    submitAnswer(val = null) {
        if (this.config.mode !== 'sprint') clearInterval(this.timer);

        const inputVal = (val !== null ? val : parseInt(document.getElementById('answerInput').value));
        if (isNaN(inputVal) && val === null) return; // Empty input

        const elapsed = (Date.now() - GameLogic.state.startTime) / 1000;
        const { isCorrect, streak } = GameLogic.checkAnswer(
            (val === -1 ? -999 : inputVal), 
            elapsed, 
            this.config.mode
        );

        if (isCorrect) {
            Sound.streak(streak, this.config.lang);
            if (streak < 5 && streak !== 10 && streak !== 20) Sound.correct();
            
            UI.showFeedback(true, false, GameLogic.state.cur);
            setTimeout(() => this.nextQuestion(), 1000);
        } else {
            Sound.wrong();
            UI.showFeedback(false, val === -1, GameLogic.state.cur);
            // Wait for user to click next
        }
    },

    finishGame() {
        this.clearTimers();
        
        // Save Record
        const hash = Storage.generateHash(this.config);
        const oldRec = Storage.getRecords()[hash];
        let isNew = false;
        
        // Record logic
        const s = GameLogic.state;
        const avg = (s.totalT / (s.correctC || 1)).toFixed(1);
        
        if (this.config.mode === 'sprint') {
            if (!oldRec || s.score > oldRec.score) { isNew = true; Storage.saveRecord(hash, { score: s.score, date: Date.now() }); }
        } else if (this.config.mode === 'fixed') {
            if (!oldRec || parseFloat(avg) < parseFloat(oldRec.time)) { isNew = true; Storage.saveRecord(hash, { time: avg, date: Date.now() }); }
        } else {
            if (!oldRec || s.count > oldRec.score) { isNew = true; Storage.saveRecord(hash, { score: s.count, date: Date.now() }); }
        }

        Sound.win(this.config.lang);
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        UI.showResults(s, this.config, isNew);
    }
};

window.onload = App.init;

</script>
</body>
</html>